```{r}
library(dplyr)
library(ggplot2)
library(tidyr)
library(janitor)
library(patchwork)

AZN_USD <- readRDS("../data/rds/AZN_USD_2015-01-30_2025-09-08.rds")

events <- c("2020-30-01",
            "2020-04-23",
            "2020-08-31",
            "2020-08-06",
            "2020-12-30",
            "2020-02-19",
            "2021-03-07",
            "2021-03-16",
            "2021-04-09",
            "2021-04-16",
            "2023-05-05"
            )

price_close <- AZN_USD_selected$price_close
ret <- price_close / dplyr::lag(AZN_USD_selected$price_close) -1
cumret <- cumprod(1 + coalesce(ret, 0)) - 1

AZN_USD_selected <- AZN_USD %>%
  group_by(ref_date) %>%
  select(ticker.x, ref_date, price_close, volume, price_adjusted) %>%
  mutate(
    ref_date = as.Date(ref_date),
    price_close = as.numeric(price_close),
    price_adjusted = as.numeric(price_adjusted),
    volume = as.numeric(volume)
  ) %>%
  mutate(
    ret = !!ret,
    cumret = !!cumret,
    is_event = ifelse(as.character(ref_date) %in% events, TRUE, FALSE)
  )


base <- ggplot(AZN_USD_selected, aes(x = ref_date, y = cumret)) +
  geom_line() +
  geom_ribbon(aes(ymax = if_else(!is_event, cumret, NA),
                  ymin = min(cumret), fill = "Non-event")) +
  geom_ribbon(aes(ymax = if_else(is_event, cumret, NA),
                  ymin = min(cumret), fill = "Event")) +
  theme(legend.position = "none") +
  theme(legend.position = "inside", legend.position.inside = c(0.2, 0.8))

with_ev <- AZN_USD_selected %>%
  filter(ref_date >= "2020-01-01", ref_date <= "2023-05-30") %>%
  ggplot(aes(x = ref_date, y = cumret)) +
  geom_line() +
  geom_ribbon(aes(ymax = if_else(!is_event, cumret, NA),
                  ymin = min(cumret), fill = "Non-event")) +
  geom_ribbon(aes(ymax = if_else(is_event, cumret, NA),
                  ymin = min(cumret), fill = "Event")) +
  theme(legend.position = "none")
base / with_ev
```
