```{r}
library(dplyr)
library(ggplot2)
library(tidyr)
library(janitor)
library(patchwork)
```

```{r}
# Function
plot_events <- function(file_path, events) {
  # Read data
  df <- readRDS(file_path)
  events <- as.Date(events)
  
  price_close <- df$price_close
  ret <- price_close / dplyr::lag(price_close) -1
  cumret <- cumprod(1 + coalesce(ret, 0)) - 1

  # Preprocess
  df <- df %>%
    group_by(ref_date) %>%
    select(contains("ticker"), ref_date, price_close, volume, price_adjusted) %>%
    mutate(
      price_close = as.numeric(price_close),
      price_adjusted = as.numeric(price_adjusted),
      volume = as.numeric(volume)
    ) %>%
    arrange(ref_date) %>%
    mutate(
      ret = !!ret,
      cumret = !!cumret,
      is_event = ref_date %in% events
    ) %>%
    mutate(
      switch = coalesce(is_event != lead(is_event), FALSE)
    )
  
  min_cumret <- min(df$cumret)
  ticker_col <- names(df)[grepl("ticker", names(df))]
  ticker_name <- df[[ticker_col[1]]][1]
  
  # Full plot
  base <- ggplot(df, aes(x = ref_date, y = cumret)) +
    geom_line() +
    geom_ribbon(aes(ymax = if_else(!is_event, cumret, NA_real_),
                    ymin = min_cumret, fill = "Non-Event")) +
    geom_ribbon(aes(ymax = if_else(is_event, cumret, NA_real_),
                    ymin = min_cumret, fill = "Event")) +
    labs(title = paste("Cumulative Returns", ticker_name)) +
    theme(legend.position = "bottom")
  
  zoomed <- df %>%
    filter(ref_date >= min(events) - 20,
           ref_date <= max(events) + 20) %>%
    ggplot(aes(x = ref_date, y = cumret)) +
    geom_line() +
    geom_ribbon(aes(ymax = if_else(!is_event | switch, cumret, NA_real_),
                    ymin = min_cumret, fill = "Non-Event")) +
    geom_ribbon(aes(ymax = if_else(is_event | switch, cumret, NA_real_),
                    ymin = min_cumret, fill = "Event")) +
    labs(title = paste("Cumulative Returns", ticker_name)) +
    theme(legend.position = "bottom")

  # Print plots
  ggsave(paste0("../output/events_", ticker_name, ".png"), plot = base)
  ggsave(paste0("../output/zoomed_events_", ticker_name, ".png"), plot = zoomed)
  print(base)
  print(zoomed)
  
  # Return useful objects
  return(list(
    events = events,
    data = df,
    ret = ret,
    cumret = cumret,
    is_event = df$is_event,
    base_plot = base,
    zoomed_plot = zoomed
  ))
}
```

```{r}
# 3 largest in market cap
file_paths <- c("../data/JNJ_yfR_2015-01-30_2025-09-08.rds",
                "../data/rds/AZN_USD_2015-01-30_2025-09-08.rds", 
                "../data/PFE_yfR_2015-01-30_2025-09-08.rds")

events_jnj <- c("2020-01-30",
                "2020-06-10",
                "2020-07-20",
                "2021-02-27",
                "2021-03-12",
                "2021-04-13",
                "2021-04-21"
                )

events_azn <- c("2020-01-30",
                "2020-04-23",
                "2020-08-31",
                "2020-09-06",
                "2020-10-23",
                "2020-12-30",
                "2021-02-19",
                "2021-03-07",
                "2021-03-16",
                "2021-04-09",
                "2021-04-16"
                )

events_pfe <- c("2020-01-30",
                "2020-12-31",
                "2021-03-10",
                "2021-10-29"
                )

events <- list(events_jnj, events_azn, events_pfe)

plotted <- vector("list", length(file_paths))

for (i in 1:3){
  plotted[[i]] = plot_events(file_paths[i], events[[i]])
}
plotted[[3]]$base_plot / plotted[[2]]$base_plot

plotted[[1]]$zoomed_plot
plotted[[2]]$zoomed_plot
plotted[[3]]$zoomed_plot

summary(plotted[[1]]$data)
```
